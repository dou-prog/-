<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>你的灵魂栖息城 - 深度心理档案</title>
    <style>
        /* 纯净高级 艺术展票根风 + 机密档案纯排版 */
        :root {
            --bg-color: #f7f5f0;
            --text-main: #2b2a28;
            --text-light: #8c8881;
            --card-bg: #ffffff;
            --primary-light: #e6dfd5;
            
            /* 动态主题色 */
            --theme-color: #5e544a; 
            --theme-stamp: #9c413b; 
            
            --shadow: 0 25px 50px rgba(0, 0, 0, 0.08);
            --serif: "Georgia", "Times New Roman", serif;
            --mono: "Courier New", Courier, monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, "PingFang SC", "Helvetica Neue", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            /* 噪点纸质肌理 */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            transition: background-color 1s ease;
        }

        #app {
            width: 100%;
            max-width: 480px;
            position: relative;
            min-height: 100vh;
            overflow: hidden;
        }

        .page {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            padding: 8vw 6vw;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.6s ease;
            overflow-y: auto;
            background-color: transparent;
        }
        .page.active { display: flex; opacity: 1; z-index: 10;}

        /* --- 装饰水印与复古边框 --- */
        .watermark { position: absolute; top: 10px; right: -20px; font-family: var(--serif); font-size: 80px; color: rgba(0, 0, 0, 0.03); font-weight: bold; z-index: -1; transform: rotate(90deg); transform-origin: right top; pointer-events: none; letter-spacing: 5px; transition: color 1s ease;}
        .frame-line { position: fixed; top: 15px; bottom: 15px; left: 15px; right: 15px; border: 1px solid var(--primary-light); pointer-events: none; z-index: 100;}
        .corner-cross { position: fixed; width: 15px; height: 15px; pointer-events: none; z-index: 101;}
        .corner-cross::before { content:''; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: var(--theme-color); transition: background 1s ease;}
        .corner-cross::after { content:''; position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: var(--theme-color); transition: background 1s ease;}
        .tl { top: 7px; left: 7px; } .tr { top: 7px; right: 7px; }
        .bl { bottom: 7px; left: 7px; } .br { bottom: 7px; right: 7px; }

        /* --- 1. 密码验证页 --- */
        #auth-page { justify-content: center; align-items: center; }
        .auth-box { text-align: center; width: 100%; padding: 50px 25px; background: var(--card-bg); position: relative; box-shadow: var(--shadow);}
        .auth-box::after { content: ''; position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px; border: 1px dashed var(--primary-light); pointer-events: none;}
        .auth-title { font-size: 20px; font-weight: 300; margin-bottom: 10px; letter-spacing: 4px; font-family: var(--serif);}
        .auth-sub { font-size: 11px; color: var(--text-light); margin-bottom: 35px; letter-spacing: 2px; text-transform: uppercase;}
        .auth-input { width: 100%; padding: 15px; border: none; border-bottom: 1px solid #ddd; background: transparent; font-size: 18px; text-align: center; letter-spacing: 6px; outline: none; transition: border 0.3s; margin-bottom: 35px;}
        .auth-input:focus { border-bottom: 1px solid var(--theme-color); }
        .btn-auth { background: var(--text-main); color: #fff; border: none; padding: 15px 45px; font-size: 13px; letter-spacing: 3px; cursor: pointer; transition: 0.3s;}

        /* --- 2. 首页 --- */
        .cover-en { font-family: var(--serif); font-size: 11px; letter-spacing: 5px; color: var(--theme-color); text-align: center; margin-top: 10vh; margin-bottom: 25px; text-transform: uppercase; transition: color 1s ease;}
        .cover-title { font-size: 28px; font-weight: 300; letter-spacing: 6px; line-height: 1.8; text-align: center; margin-bottom: 30px;}
        .cover-subtitle { font-size: 13px; color: var(--text-light); text-align: center; line-height: 2.2; letter-spacing: 2px; }
        .btn-start { margin-top: 8vh; background: var(--text-main); color: #fff; border: none; padding: 18px 0; font-size: 14px; letter-spacing: 4px; box-shadow: 0 15px 30px rgba(0,0,0,0.1); transition: transform 0.2s; position: relative; z-index: 200; width: 100%;}
        .btn-start:active { transform: scale(0.96); }
        .btn-history { margin-top: 20px; background: transparent; color: var(--text-main); border: 1px solid var(--primary-light); padding: 14px 0; font-size: 12px; letter-spacing: 2px; position: relative; z-index: 200; width: 100%; font-family: var(--mono); cursor: pointer;}

        /* --- 2.5 历史记录页 --- */
        #history-page { padding-top: 10vh; padding-bottom: 50px;}
        .history-title { font-family: var(--serif); font-size: 16px; text-align: center; letter-spacing: 4px; margin-bottom: 30px; border-bottom: 1px solid var(--primary-light); padding-bottom: 15px;}
        .history-list { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px;}
        .history-item { background: var(--card-bg); padding: 25px 20px; border: 1px solid var(--primary-light); font-family: var(--mono); position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.03);}
        .history-item::before { content: 'CONFIDENTIAL'; position: absolute; right: 15px; top: 12px; font-size: 9px; color: var(--theme-stamp); font-weight: bold; letter-spacing: 1px; border: 1px solid var(--theme-stamp); padding: 2px 4px; transform: rotate(5deg); opacity: 0.7; transition: color 1s, border-color 1s;}
        .hi-id { font-size: 10px; color: var(--text-light); margin-bottom: 10px; letter-spacing: 1px; border-bottom: 1px dashed #eee; padding-bottom: 5px;}
        .hi-row { font-size: 12px; color: var(--theme-color); line-height: 2; letter-spacing: 0.5px; transition: color 1s ease;}
        .hi-whisper { margin-top: 12px; padding-top: 12px; border-top: 1px dashed #eee; font-size: 11px; color: var(--text-main); font-style: italic; line-height: 1.6; font-family: "PingFang SC", sans-serif;}
        .empty-history { text-align: center; font-size: 12px; color: var(--text-light); letter-spacing: 2px; margin-top: 50px; font-family: var(--mono);}
        .history-actions { display: flex; flex-direction: column; gap: 15px; margin-top: 20px;}
        .btn-back { background: var(--text-main); color: #fff; border: none; padding: 15px; width: 100%; font-size: 12px; letter-spacing: 2px; cursor: pointer; font-family: var(--mono);}
        .btn-clear { background: transparent; color: #9c413b; border: 1px solid #9c413b; padding: 15px; width: 100%; font-size: 12px; letter-spacing: 2px; cursor: pointer; font-family: var(--mono); opacity: 0.8;}

        /* --- 3. 答题页 --- */
        .progress-wrapper { display: flex; align-items: center; justify-content: space-between; margin-top: 20px; margin-bottom: 40px; }
        .progress-bar { flex-grow: 1; height: 1px; background: var(--primary-light); margin: 0 20px; position: relative;}
        .progress-inner { height: 100%; background: var(--theme-color); width: 0%; transition: width 0.4s ease, background 1s ease; position: absolute; left:0; top: -1px; border-bottom: 2px solid var(--theme-color);}
        .q-num { font-family: var(--serif); font-size: 14px; color: var(--theme-color); font-style: italic; transition: color 1s ease;}
        
        .question-card { background: var(--card-bg); padding: 50px 30px; box-shadow: var(--shadow); transform: translateY(0); transition: transform 0.4s ease, opacity 0.4s ease; position: relative; z-index: 200;}
        .question-card::before { content: ''; position: absolute; top: -10px; left: 10px; right: 10px; height: 10px; background: rgba(255,255,255,0.5); z-index: -1;}
        .question-card.slide-out { transform: translateX(-100%); opacity: 0; }
        .question-card.slide-in { animation: slideIn 0.5s forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .q-title { font-size: 17px; line-height: 1.9; margin-bottom: 40px; font-weight: 400; letter-spacing: 1px; color: #1a1a1a; text-align: justify;}
        .option { background: transparent; padding: 18px 20px; margin-bottom: 16px; font-size: 14px; line-height: 1.6; cursor: pointer; border: 1px solid #e0ddd8; transition: all 0.2s; letter-spacing: 1px;}
        .option:active { background: var(--theme-color); color: #fff; border-color: var(--theme-color);}

        /* --- 4. 结果页 (典藏机密纯排版) --- */
        #result-page { padding-bottom: 60px; padding-top: 40px;}
        .result-container { background: var(--card-bg); padding: 45px 20px; position: relative; box-shadow: var(--shadow); z-index: 200; margin-bottom: 40px;}
        .result-container::after { content: ''; position: absolute; top: 6px; left: 6px; right: 6px; bottom: 6px; border: 1px solid var(--primary-light); pointer-events: none;}
        
        .stamp { position: absolute; top: 25px; right: 20px; width: 65px; height: 65px; border: 2px solid var(--theme-stamp); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--theme-stamp); font-family: var(--serif); font-size: 9px; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; text-align: center; line-height: 1.2; transform: rotate(15deg); opacity: 0.8; padding: 5px; z-index: 10; transition: color 1s ease, border-color 1s ease;}
        .stamp::after { content: ''; position: absolute; width: 55px; height: 55px; border: 1px dashed var(--theme-stamp); border-radius: 50%; transition: border-color 1s ease;}

        .result-top-en { font-family: var(--serif); font-size: 10px; color: var(--text-light); text-align: center; letter-spacing: 4px; margin-bottom: 35px; }
        .city-name { font-size: 56px; font-weight: 300; margin: 20px 0; color: var(--theme-color); letter-spacing: 12px; font-family: "PingFang SC", serif; text-align: center; transition: color 1s ease;}
        
        .model-badges { display: flex; justify-content: center; gap: 8px; margin-bottom: 40px; }
        .badge { background: #fdfcfb; color: var(--theme-color); padding: 5px 12px; font-size: 11px; letter-spacing: 1px; border: 1px solid #e8e6e1; transition: color 1s ease;}

        /* --- 视觉焦点：排版巨幕引言 (Hero Whisper) --- */
        .hero-whisper { font-size: 16px; color: var(--theme-color); font-family: var(--serif); font-style: italic; text-align: center; padding: 35px 25px; line-height: 2; letter-spacing: 1.5px; position: relative; margin: 20px 0 45px 0; border-top: 1px dashed var(--primary-light); border-bottom: 1px dashed var(--primary-light); transition: color 1s ease;}
        .hero-whisper::before { content: '“'; font-size: 60px; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); color: var(--primary-light); opacity: 0.6; z-index: -1; font-style: normal;}
        
        .section-title-box { display: flex; align-items: center; justify-content: center; margin: 40px 0 30px; }
        .section-title-line { height: 1px; background: var(--primary-light); flex-grow: 1; }
        .section-title { padding: 0 15px; font-size: 11px; font-weight: 400; color: var(--text-light); letter-spacing: 4px; font-family: var(--serif);}

        .match-box { background: rgba(255,255,255,0.5); border: 1px dashed var(--theme-color); padding: 30px 25px; margin-bottom: 40px; text-align: center; transition: border-color 1s ease;}
        .match-title { font-family: var(--mono); font-size: 10px; color: var(--text-light); letter-spacing: 2px; margin-bottom: 15px;}
        .match-rate { font-family: var(--serif); font-size: 52px; color: var(--theme-color); font-weight: bold; letter-spacing: 2px; margin-bottom: 15px; transition: color 1s ease;}
        .match-reason { font-size: 13px; line-height: 1.9; color: var(--text-main); font-weight: 300; letter-spacing: 1px;}

        .result-desc { font-size: 14px; line-height: 2.2; color: var(--text-main); text-align: justify; padding: 0 10px; margin-bottom: 10px; white-space: pre-wrap; letter-spacing: 1px; font-weight: 300;}

        .donut-wrapper { display: flex; align-items: center; justify-content: center; margin: 30px 0 40px; gap: 30px;}
        .donut-chart { width: 130px; height: 130px; border-radius: 50%; position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); transform: rotate(-90deg);}
        .donut-chart::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 75px; height: 75px; background: var(--card-bg); border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.05);}
        .donut-legend { display: flex; flex-direction: column; gap: 12px;}
        .legend-item { display: flex; align-items: center; font-size: 12px; letter-spacing: 1px; color: var(--text-main); font-weight: 300;}
        .legend-color { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        .legend-pct { font-family: var(--serif); font-weight: bold; margin-left: 8px; font-size: 13px; color: var(--theme-color); transition: color 1s ease;}

        .radar-container { width: 100%; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; position: relative; padding: 10px 0;}
        .radar-svg { width: 280px; height: 280px; overflow: visible; }
        .radar-label { font-size: 11px; fill: var(--text-light); letter-spacing: 1px; font-weight: 300; }
        .radar-value-text { font-family: var(--serif); font-size: 10px; fill: var(--theme-color); transition: fill 1s ease;}

        .footer-action { text-align: center; margin-top: 20px; padding: 30px 0; border-top: 1px solid var(--primary-light); position: relative; z-index: 200;}
        .footer-action p { font-size: 12px; color: var(--text-light); letter-spacing: 3px; line-height: 2; margin-bottom: 20px;}
        .btn-reboot { background: transparent; color: var(--text-main); border: 1px solid var(--theme-color); padding: 12px 30px; font-size: 11px; letter-spacing: 3px; cursor: pointer; font-family: var(--mono); transition: 0.3s;}
        .btn-reboot:active { background: var(--theme-color); color: #fff; }

        .loader { width: 1px; height: 70px; background: var(--primary-light); margin: 35vh auto 30px; position: relative; overflow: hidden;}
        .loader::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 30%; background: var(--theme-color); animation: scan 1.5s ease-in-out infinite; transition: background 1s ease;}
        @keyframes scan { 0% { top: -30%; } 100% { top: 100%; } }
        .loading-text { text-align: center; font-size: 13px; color: var(--text-light); line-height: 2.2; letter-spacing: 3px;}
    </style>
</head>
<body>

<div id="app">
    <div class="watermark" id="bg-watermark">ARCHIVE</div>
    <div class="frame-line"></div>
    <div class="corner-cross tl"></div>
    <div class="corner-cross tr"></div>
    <div class="corner-cross bl"></div>
    <div class="corner-cross br"></div>

    <!-- 0. 密码验证页 -->
    <div id="auth-page" class="page active">
        <div class="auth-box">
            <h2 class="auth-title">潜意识密钥</h2>
            <p class="auth-sub">Identity Verification</p>
            <input type="text" id="passcode" class="auth-input" placeholder="输入专属兑换码" maxlength="6">
            <button class="btn-auth" onclick="verifyCode()">VERIFY</button>
        </div>
    </div>

    <!-- 1. 首页 -->
    <div id="start-page" class="page">
        <div class="cover-en">Psychological Resonance Profile</div>
        <h1 class="cover-title">测一测你的灵魂<br>栖息在中国哪座城</h1>
        <p class="cover-subtitle">
            融合潜意识波谱与荣格原型<br>
            解剖那些你未曾察觉的隐秘渴望
        </p>
        <button class="btn-start" onclick="startTest()">开启深度扫描</button>
        <button class="btn-history" onclick="showHistory()">[ 调取灵魂档案柜 ]</button>
    </div>

    <!-- 1.5 历史记录页 -->
    <div id="history-page" class="page">
        <h2 class="history-title">PAST ARCHIVES</h2>
        <div class="history-list" id="history-list"></div>
        <div class="history-actions">
            <button class="btn-back" onclick="hideHistory()">RETURN (返回主页)</button>
            <button class="btn-clear" onclick="clearHistory()">CLEAR ARCHIVE (销毁档案)</button>
        </div>
    </div>

    <!-- 2. 答题页 -->
    <div id="question-page" class="page">
        <div class="progress-wrapper">
            <span class="q-num">Q.01</span>
            <div class="progress-bar"><div class="progress-inner" id="progress"></div></div>
            <span class="q-num">20</span>
        </div>
        <div class="question-card" id="q-card">
            <div class="q-title" id="q-title">题目加载中...</div>
            <div id="options-container"></div>
        </div>
    </div>

    <!-- 3. 加载计算页 -->
    <div id="loading-page" class="page">
        <div class="loader"></div>
        <p class="loading-text">正在捕获你的潜意识频率...<br>交叉比对灵魂暗影...</p>
    </div>

    <!-- 4. 结果页 (典藏纯文字版) -->
    <div id="result-page" class="page">
        <div class="result-container">
            <div class="stamp" id="res-stamp">Soul<br>Certified</div>
            <div class="result-top-en">CONFIDENTIAL SOUL ARCHIVE</div>
            
            <div style="text-align: center; font-size: 12px; color: var(--text-light); letter-spacing: 3px; margin-bottom: 5px;">你的灵魂频率最终共振于</div>
            <div class="city-name" id="res-city">加载中</div>
            
            <div class="model-badges">
                <span class="badge" id="res-mbti">MBTI: --</span>
                <span class="badge" id="res-jung">荣格原型: --</span>
            </div>

            <!-- 纯文字排版的灵魂私语 (巨幕引言) -->
            <div class="hero-whisper" id="res-whisper">“加载中...”</div>

            <!-- 空间同频度与理由 -->
            <div class="match-box">
                <div class="match-title">SPATIAL RESONANCE (空间同频度)</div>
                <div class="match-rate" id="res-match">98.5%</div>
                <div class="match-reason" id="res-reason">同频解析加载中...</div>
            </div>
            
            <div class="section-title-box">
                <div class="section-title-line"></div>
                <div class="section-title">SOUL ANALYSIS</div>
                <div class="section-title-line"></div>
            </div>
            <div class="result-desc" id="res-desc">解析生成中...</div>

            <div class="section-title-box">
                <div class="section-title-line"></div>
                <div class="section-title">COMPOSITION</div>
                <div class="section-title-line"></div>
            </div>
            <div class="donut-wrapper">
                <div class="donut-chart" id="donut-chart"></div>
                <div class="donut-legend" id="donut-legend"></div>
            </div>

            <div class="section-title-box">
                <div class="section-title-line"></div>
                <div class="section-title">COGNITIVE RADAR</div>
                <div class="section-title-line"></div>
            </div>
            <div class="radar-container" id="radar-container"></div>
            
            <p style="text-align: center; font-size: 11px; color: #bbaea0; letter-spacing: 1px; margin-top: 10px;">* 数据基于您的潜意识第一反应提取</p>
        </div>

        <div class="footer-action">
            <p>↓ 长按屏幕保存你的专属灵魂档案 ↓<br>Share your authentic soul</p>
            <button class="btn-reboot" onclick="restartTest()">[ REBOOT SCAN 重启扫描 ]</button>
        </div>
    </div>
</div>

<script>
    /* =========================================
       1. 密码验证逻辑
       ========================================= */
    const VALID_CODES = ["8864", "2026", "5200"]; 
    function verifyCode() {
        const input = document.getElementById('passcode').value.trim();
        if (VALID_CODES.includes(input)) {
            document.getElementById('auth-page').classList.remove('active');
            document.getElementById('start-page').classList.add('active');
        } else {
            alert("密钥无效，请核对小红书自动发货私信。");
        }
    }
    document.getElementById('passcode').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') verifyCode();
    });

    /* =========================================
       2. 高级历史记录系统
       ========================================= */
    function saveHistory(cityData, mbti, matchRate) {
        let history = JSON.parse(localStorage.getItem('soul_history')) || [];
        const date = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute:'2-digit' });
        history.unshift({ 
            id: Math.floor(Math.random() * 90000) + 10000,
            date: date, city: cityData.name, mbti: mbti, jung: cityData.jung, match: matchRate,
            whisper: cityData.whisper, themeColor: cityData.themeColor 
        });
        if (history.length > 8) history.pop();
        localStorage.setItem('soul_history', JSON.stringify(history));
    }

    function showHistory() {
        document.getElementById('start-page').classList.remove('active');
        document.getElementById('history-page').classList.add('active');
        
        let history = JSON.parse(localStorage.getItem('soul_history')) || [];
        const listDiv = document.getElementById('history-list');
        listDiv.innerHTML = '';

        if (history.length === 0) {
            listDiv.innerHTML = '<div class="empty-history">/// 档案柜为空，未发现潜意识痕迹 ///</div>';
            return;
        }

        history.forEach((item) => {
            const color = item.themeColor || 'var(--accent)';
            listDiv.innerHTML += `
                <div class="history-item">
                    <div class="hi-id">ID: #${item.id} &nbsp;|&nbsp; DATE: ${item.date}</div>
                    <div class="hi-row" style="color: ${color}">CITY: [ ${item.city} ] - MATCH: ${item.match}</div>
                    <div class="hi-row" style="color: ${color}">MODEL: ${item.mbti} (${item.jung})</div>
                    <div class="hi-whisper">“${item.whisper}”</div>
                </div>
            `;
        });
    }

    function hideHistory() {
        document.getElementById('history-page').classList.remove('active');
        document.getElementById('start-page').classList.add('active');
    }

    function clearHistory() {
        if(confirm("警告：此操作将永久抹除本地保留的所有灵魂潜意识档案。确定要销毁吗？")) {
            localStorage.removeItem('soul_history');
            showHistory(); 
        }
    }

    /* =========================================
       3. 专业题库
       ========================================= */
    const questions = [
        { text: "度过极其疲惫的一周后，哪种方式能让你满血复活？", options: [ { text: "参加有趣的社交聚会，在人群中汲取能量", val: "E" }, { text: "关闭手机，一个人窝在房间里看剧或发呆", val: "I" } ] },
        { text: "在陌生人很多的破冰场合，你通常的潜意识反应是？", options: [ { text: "感到兴奋，主动寻找有趣的人开启话题", val: "E" }, { text: "感到耗能，更倾向于待在角落默默观察", val: "I" } ] },
        { text: "你对“独处”这个概念的真实感受是？", options: [ { text: "偶尔需要，但时间久了会觉得空虚无聊", val: "E" }, { text: "这是绝对的必需品，是我灵魂呼吸的时刻", val: "I" } ] },
        { text: "当被要求即兴发表观点时，你的思维模式更倾向于？", options: [ { text: "边说边想，通过表达来理清逻辑", val: "E" }, { text: "先在脑海中深思熟虑，组织好语言再开口", val: "I" } ] },
        { text: "你的朋友们通常会如何评价你的社交属性？", options: [ { text: "开朗热情，是圈子里的气氛活跃者", val: "E" }, { text: "安静内敛，带有一点距离与神秘感", val: "I" } ] },
        { text: "当你听到“未来”这个词，你的第一反应是？", options: [ { text: "规划眼前的每一步，未来是脚踏实地走出来的", val: "S" }, { text: "脑海中浮现出各种宏大的画面和无限的可能性", val: "N" } ] },
        { text: "描述一件经历过的事情时，你的表达习惯是？", options: [ { text: "精确还原当时的时间、地点和具体细节", val: "S" }, { text: "略过细节，直接提炼这件事的深层寓意或感受", val: "N" } ] },
        { text: "面对一份复杂的说明书或新软件，你通常？", options: [ { text: "仔细阅读操作步骤，按部就班地执行", val: "S" }, { text: "凭直觉先瞎折腾一番，摸索大概的底层逻辑", val: "N" } ] },
        { text: "在欣赏一幅抽象画时，你更容易关注？", options: [ { text: "画家运用的色彩搭配、光影和笔触技巧", val: "S" }, { text: "画面背后隐藏的情感隐喻和符号象征", val: "N" } ] },
        { text: "你更欣赏哪一种生活态度？", options: [ { text: "活在当下，享受触手可及的现世安稳", val: "S" }, { text: "追寻意义，即使那意味着脱离现实的轨道", val: "N" } ] },
        { text: "朋友向你哭诉在职场遭遇的不公，你本能的做法是？", options: [ { text: "帮TA分析利弊，寻找解决问题的客观方法", val: "T" }, { text: "提供极高的情绪价值，与TA共情并谴责对方", val: "F" } ] },
        { text: "在评价一个人是否优秀时，你更看重？", options: [ { text: "TA的能力、效率以及取得的实际成就", val: "T" }, { text: "TA的人品、善良以及对他人的关怀程度", val: "F" } ] },
        { text: "如果你要开除一个工作不达标但很努力的员工，你会？", options: [ { text: "坚持原则，按规章办事", val: "T" }, { text: "内心极其煎熬，会试图帮TA找其他出路", val: "F" } ] },
        { text: "在争论中，你认为哪一点更重要？", options: [ { text: "逻辑严密，找出事实真相，即使有些伤人", val: "T" }, { text: "维护和谐，照顾对方的感受，即使妥协真相", val: "F" } ] },
        { text: "你认为自己更像是一个被什么驱动的人？", options: [ { text: "清醒的头脑与理性的冰冷法则", val: "T" }, { text: "跳动的心脏与滚烫的情感准则", val: "F" } ] },
        { text: "对于即将到来的一次长途旅行，你的状态是？", options: [ { text: "行程表精细到小时，酒店机票全部落定才安心", val: "J" }, { text: "只定好目的地，随遇而安，享受未知的惊喜", val: "P" } ] },
        { text: "面对DDL(最后期限)，你的工作节奏通常是？", options: [ { text: "提前拆解任务，有条不紊地尽早完成", val: "J" }, { text: "不到最后一刻没有灵感，习惯极限冲刺", val: "P" } ] },
        { text: "你如何看待生活中的“突发变故”？", options: [ { text: "这会打乱我的计划，让我感到焦虑和烦躁", val: "J" }, { text: "兵来将挡水来土掩，有时反而觉得很刺激", val: "P" } ] },
        { text: "你的手机桌面和电脑文件通常是？", options: [ { text: "分门别类，排列整齐，强迫症福音", val: "J" }, { text: "比较随意，只要我自己能找到就行", val: "P" } ] },
        { text: "你更希望自己的人生是怎样的？", options: [ { text: "一切尽在掌控之中，稳步上升的确定性", val: "J" }, { text: "充满弹性，随时可以转向的旷野", val: "P" } ] }
    ];

    /* =========================================
       4. 核心数据字典 (移除图片配置，保留色彩与排版文本)
       ========================================= */
    const cities = {
        "INFP": { 
            name: "大理", jung: "寻道者 / 创造者", 
            themeColor: "#577a82", themeStamp: "#577a82", 
            whisper: "苍山覆雪，洱海无波。你生来就缺少一层保护壳，这让你痛，也让你能感知到最细微的风。",
            matchReason: "你的【极致共情】与大理的苍蓝色天空同频，你拒绝被内卷裹挟的随性，让灵魂在此处达到了完美的舒展。",
            radar: [95, 95, 30, 20, 40], 
            donut: [ { label: "极致共情", val: 45, col: "#577a82" }, { label: "精神内耗", val: 35, col: "#8ea4a8" }, { label: "自我孤立", val: 20, col: "#c3d0d2" } ],
            text: "你终其一生，都在治愈那种骨子里的流浪感。\n\n在世俗的眼光里，你或许有些“不切实际”。但只有你自己知道，为了守护内心那片未被污染的纯洁之地，你耗费了多少心力去对抗这个充斥着功利的世界。\n\n大理的苍山洱海，是你灵魂的倒影。你很容易被一首诗、一抹晚霞打动。请停止对自己的内耗与怀疑吧，你无需向这个世界证明什么，你本身就是一首极其珍贵的、未完的诗。" 
        },
        "INFJ": { 
            name: "杭州", jung: "预言家 / 智者", 
            themeColor: "#687c6b", themeStamp: "#687c6b", 
            whisper: "灵隐的钟声敲碎了水面的倒影。你能轻易看穿所有人的伪装，却独自吞下清醒的代价。",
            matchReason: "你骨子里的【深邃哲思】与江南水乡的黛绿色底蕴完美互溶，在此地，你的精神洁癖将得到最温柔的安放。",
            radar: [85, 90, 40, 60, 75], 
            donut: [ { label: "深邃哲思", val: 50, col: "#687c6b" }, { label: "精神洁癖", val: 30, col: "#95a397" }, { label: "宿命悲观", val: 20, col: "#c5c9c5" } ],
            text: "你用极度的悲观来托底，却又在缝隙里偷偷期待着奇迹。\n\n你拥有最罕见、也最深邃的灵魂。你极其敏锐，总能在人群中一眼看穿事物运行的本质。你外表温和宁静，内心却有着极度坚定的精神洁癖，这让你在人际交往中常常感到一种无可救药的孤独感。\n\n杭州的烟雨完美契合了你的特质。你不喜欢无意义的喧嚣社交，你像一幅留白的水墨画，在默默缝补这个略显粗糙的世界。原谅自己的孤独吧，高维度的灵魂注定是要独自走过长夜的。" 
        },
        "INTJ": { 
            name: "深圳", jung: "统治者 / 策略家", 
            themeColor: "#3b4b5e", themeStamp: "#3b4b5e", 
            whisper: "你不是没有感情，你只是把最深沉的爱，用最冰冷深邃的逻辑包裹了起来。",
            matchReason: "你的【绝对理性】与这座城市的超高运转效率如同精密齿轮般咬合，唯有这里的旷野能承载你的野心。",
            radar: [80, 20, 30, 90, 95], 
            donut: [ { label: "绝对理性", val: 55, col: "#3b4b5e" }, { label: "掌控野心", val: 30, col: "#6e7a89" }, { label: "情感隔离", val: 15, col: "#a9b1ba" } ],
            text: "在绝对理性的冰川下，藏着你不轻易示人的滚烫野心。\n\n人们往往只看到你极其理智、高效甚至有些“冷酷”的一面，却不知这是你用来保护自己的铠甲。你在脑海中时刻构建着庞大的系统，厌恶一切低效与愚蠢。\n\n拔地而起的深圳，是你最好的精神归宿。这里没有历史包袱，只有代码和改变世界的渴望。在这座霓虹闪烁的科技之城里，你可以心无旁骛地挥舞你理性的手术刀。不要害怕被人误解为傲慢，你是注定要改写游戏规则的人。" 
        },
        "ENFP": { 
            name: "重庆", jung: "魔术师 / 探索者", 
            themeColor: "#bc4a41", themeStamp: "#bc4a41", 
            whisper: "赛博朋克的霓虹和滚烫的底色。你用热烈去对抗虚无，每一次燃烧都是毫无保留的献祭。",
            matchReason: "你潜意识里的【冒险战栗】与3D魔幻的城市肌理天生一对，热烈而滚烫的灵魂注定要在这里燃烧。",
            radar: [98, 85, 50, 10, 50], 
            donut: [ { label: "无尽好奇", val: 45, col: "#bc4a41" }, { label: "存在虚无", val: 35, col: "#d4817a" }, { label: "注意力涣散", val: 20, col: "#eac1bd" } ],
            text: "你像一团没有形状的火，渴望烧尽一切庸常，却又总在清晨感到彻骨的虚无。\n\n你总是充满着旺盛的好奇心和天马行空的想象力，你拒绝任何一眼望到头的生活。但在人群散去的深夜，你比任何人都能感知到那种深不见底的孤独。\n\n重庆的3D魔幻完全是你灵魂的镜像。这座城市从不讲究所谓的“规矩”，充满了不确定性的刺激。你在这里如鱼得水。不要因为短暂的迷茫而自我怀疑，你的存在本身，就是为了在这个世界制造绚烂的烟火。" 
        },
        "ISFJ": { 
            name: "苏州", jung: "照顾者 / 守护者", 
            themeColor: "#9e8568", themeStamp: "#9e8568", 
            whisper: "青砖伴瓦漆，你总是在成全别人，却把那个最需要拥抱的自己，留在了雨里。",
            matchReason: "你对【现世羁绊】的珍视与这座城市暖茶色的古典意境极其契合，你的细腻在这里永远不会被辜负。",
            radar: [30, 90, 95, 75, 40], 
            donut: [ { label: "现世羁绊", val: 50, col: "#9e8568" }, { label: "讨好内耗", val: 30, col: "#c1af9c" }, { label: "细节掌控", val: 20, col: "#dfd6cc" } ],
            text: "你习惯了给别人撑伞，却常常忘了自己也会被淋湿。\n\n你的灵魂散发着一种让人无比安心的暖意。你总是极其敏锐地察觉他人的需求，习惯性地把别人的感受放在自己之前。你渴望稳定、和谐的生活，却常常在深夜因为某人的一句话而辗转反侧。\n\n苏州的园林与水乡，是你灵魂的具象化。温润、不具攻击性，却有着绵长的力量。在这座小桥流水的城市里，你的善良将得到最温柔的回应。但请记住，偶尔自私一点，也是被允许的。" 
        },
        "INTP": { 
            name: "南京", jung: "学者 / 逻辑学家", 
            themeColor: "#a67c46", themeStamp: "#a67c46", 
            whisper: "琥珀色的梧桐落叶下，比起在荒诞的世界里寻找认同，你更愿意在精神废墟中独自加冕。",
            matchReason: "你的【真理解构】需求与六朝古都的深厚底蕴产生了跨越时空的共鸣，孤高灵魂在此觅得归处。",
            radar: [90, 30, 20, 40, 98], 
            donut: [ { label: "真理解构", val: 60, col: "#a67c46" }, { label: "社交冷漠", val: 25, col: "#c7a87e" }, { label: "思想游离", val: 15, col: "#e4d3bd" } ],
            text: "你冷眼旁观这个世界的喧嚣，只向宇宙的客观真理低头。\n\n你的灵魂是一座孤高的图书馆。你对探究宇宙的底层逻辑有着近乎病态的痴迷。在世俗看来，你或许有些“懒散”或“冷漠”，但你的大脑其实每秒钟都在进行着极其绚丽的风暴。\n\n南京这座六朝古都，藏着你需要的底蕴。它有着深厚的学术氛围和不张扬的烟水气。在这里，你可以躲进梧桐树的阴影里，冷眼旁观历史的兴衰。你那充满智慧的灵魂，不需要迎合任何人。" 
        },
        "ESTP": { 
            name: "武汉", jung: "战士 / 冒险家", 
            themeColor: "#786c67", themeStamp: "#786c67", 
            whisper: "大江大河，钢铁灰的果决。你迷恋危机的气味，那些杀不死你的，终将成为你的王冠。",
            matchReason: "你骨子里的【快意恩仇】与码头文化的江湖气天然相吸，这里的狂野能包容你所有的离经叛道。",
            radar: [80, 30, 60, 30, 85], 
            donut: [ { label: "冒险战栗", val: 45, col: "#786c67" }, { label: "现实主义", val: 35, col: "#a39994" }, { label: "规则藐视", val: 20, col: "#cfc9c7" } ],
            text: "规则对你来说就是用来打破的，你迷恋那种在悬崖边起舞的战栗感。\n\n你的灵魂充满了极具爆发力的江湖气！你永远活在当下，热衷于行动、冒险和肾上腺素飙升的感觉。你讨厌虚伪的客套和长篇大论的说教，你只相信自己的直觉和手腕。\n\n武汉这座码头文化深厚的城市，和你的气场完美融合。过早的烟火气呼应着你果断、甚至有些莽撞的生命力。你不怕困难，甚至享受在混乱中杀出一条血路，这个世界需要你这样敢于掀桌子的人。" 
        },
        "ISFP": { 
            name: "成都", jung: "流浪者 / 艺术家", 
            themeColor: "#7b8e5c", themeStamp: "#7b8e5c", 
            whisper: "竹影婆娑，你拒绝被时代的齿轮裹挟，你只愿做一阵不被定义的风。",
            matchReason: "你对【感官美学】的极致追求与这座城市竹叶青的慵懒底色无缝对接，你的浪漫在这里是合法的。",
            radar: [85, 80, 60, 20, 30], 
            donut: [ { label: "感官美学", val: 50, col: "#7b8e5c" }, { label: "随性慵懒", val: 30, col: "#a5b48b" }, { label: "隐性叛逆", val: 20, col: "#d1dabf" } ],
            text: "你只对真实的美和当下的微风心动，其他的宏大叙事，于你而言都是噪音。\n\n你的灵魂是一首慵懒的民谣。你拥有极高的美学感知力和内敛的情感，你不追求宏大叙事，只在乎今天的咖啡够不够香。很多人觉得你随波逐流，但你其实有着极强的内在底线。\n\n成都简直是为你量身定做的容器。你骨子里带着迷人的松弛感，坚决拒绝被现代社会的内卷裹挟。你的随性与独特的艺术直觉，将在这里被无限放大，你生来就是为了体验这人间的声色犬马。" 
        }
    };

    const mbtiMap = { "ENTP": "ENFP", "ENTJ": "INTJ", "ENFJ": "INFJ", "ESTJ": "INTJ", "ESFJ": "ISFJ", "ISTJ": "ISFJ", "ISTP": "INTP", "ESFP": "ENFP" };

    /* =========================================
       5. 核心交互控制
       ========================================= */
    let currentQuestion = 0;
    let scores = { E:0, I:0, S:0, N:0, T:0, F:0, J:0, P:0 };

    function startTest() {
        document.getElementById('start-page').classList.remove('active');
        document.getElementById('question-page').classList.add('active');
        
        document.documentElement.style.setProperty('--theme-color', '#5e544a');
        document.documentElement.style.setProperty('--theme-stamp', '#9c413b');
        document.getElementById('bg-watermark').innerText = "ARCHIVE";

        renderQuestion();
    }

    function restartTest() {
        currentQuestion = 0;
        scores = { E:0, I:0, S:0, N:0, T:0, F:0, J:0, P:0 };
        document.getElementById('progress').style.width = '0%';
        
        document.documentElement.style.setProperty('--theme-color', '#5e544a');
        document.documentElement.style.setProperty('--theme-stamp', '#9c413b');
        document.getElementById('bg-watermark').innerText = "ARCHIVE";

        document.getElementById('result-page').classList.remove('active');
        document.getElementById('start-page').classList.add('active');
        document.getElementById('start-page').scrollTop = 0;
    }

    function renderQuestion() {
        const qCard = document.getElementById('q-card');
        qCard.classList.remove('slide-in');
        void qCard.offsetWidth; 
        qCard.classList.add('slide-in');

        const q = questions[currentQuestion];
        const qIndex = String(currentQuestion + 1).padStart(2, '0');
        document.querySelector('.q-num:first-child').innerText = `Q.${qIndex}`;
        document.getElementById('q-title').innerText = q.text;
        
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        
        q.options.forEach(opt => {
            const div = document.createElement('div');
            div.className = 'option';
            div.innerText = opt.text;
            div.onclick = () => handleAnswer(opt.val);
            container.appendChild(div);
        });

        const progress = (currentQuestion / 20) * 100;
        document.getElementById('progress').style.width = progress + '%';
    }

    function handleAnswer(value) {
        scores[value]++;
        const qCard = document.getElementById('q-card');
        qCard.classList.remove('slide-in');
        qCard.classList.add('slide-out');

        setTimeout(() => {
            qCard.classList.remove('slide-out');
            currentQuestion++;
            if (currentQuestion < questions.length) {
                renderQuestion();
            } else {
                showLoading();
            }
        }, 300);
    }

    function showLoading() {
        document.getElementById('progress').style.width = '100%';
        document.getElementById('question-page').classList.remove('active');
        document.getElementById('loading-page').classList.add('active');
        
        setTimeout(() => {
            calculateResult();
        }, 3000); 
    }

    function calculateResult() {
        document.getElementById('loading-page').classList.remove('active');
        document.getElementById('result-page').classList.add('active');
        document.getElementById('result-page').scrollTop = 0;

        const type = [
            scores.E > scores.I ? 'E' : 'I',
            scores.S > scores.N ? 'S' : 'N',
            scores.T > scores.F ? 'T' : 'F',
            scores.J > scores.P ? 'J' : 'P'
        ].join('');

        let finalType = cities[type] ? type : mbtiMap[type];
        if(!finalType) finalType = "INFP"; 
        
        const data = cities[finalType];
        const matchRate = (96.5 + Math.random() * 3.4).toFixed(2) + '%';

        // 动态切换全局主题潘通色
        document.documentElement.style.setProperty('--theme-color', data.themeColor);
        document.documentElement.style.setProperty('--theme-stamp', data.themeStamp);
        document.getElementById('bg-watermark').innerText = data.name;

        // 填充结果数据
        document.getElementById('res-city').innerText = data.name;
        document.getElementById('res-mbti').innerText = `MBTI: ${type}`;
        document.getElementById('res-jung').innerText = `原型: ${data.jung}`;
        
        document.getElementById('res-whisper').innerText = data.whisper; // 无需手动加引号，CSS已包含
        
        document.getElementById('res-match').innerText = matchRate;
        document.getElementById('res-reason').innerText = data.matchReason;

        document.getElementById('res-desc').innerText = data.text;

        saveHistory(data, type, matchRate);

        drawDonutChart(data.donut);
        drawRadarChart(data.radar, data.themeColor);
    }

    /* =========================================
       6. 饼图算法 
       ========================================= */
    function drawDonutChart(donutData) {
        let conicString = '';
        let legendHTML = '';
        let currentPct = 0;

        donutData.forEach((item, index) => {
            const nextPct = currentPct + item.val;
            conicString += `${item.col} ${currentPct}% ${nextPct}%${index < donutData.length - 1 ? ',' : ''}`;
            currentPct = nextPct;
            legendHTML += `
                <div class="legend-item">
                    <div class="legend-color" style="background:${item.col}"></div>
                    <span>${item.label}</span>
                    <span class="legend-pct" style="color:${item.col}">${item.val}%</span>
                </div>
            `;
        });

        document.getElementById('donut-chart').style.background = `conic-gradient(${conicString})`;
        document.getElementById('donut-legend').innerHTML = legendHTML;
    }

    /* =========================================
       7. 纯手写 SVG 动态着色雷达图
       ========================================= */
    function drawRadarChart(dataValues, themeColor) {
        const container = document.getElementById('radar-container');
        const labels = ["精神自由度", "情感细腻度", "现世羁绊感", "秩序掌控欲", "逻辑锋利度"];
        const size = 280, center = size / 2, radius = 80;
        
        function getPoint(a, val) {
            const rad = (a * Math.PI) / 180;
            const r = radius * (val / 100);
            return { x: center + r * Math.cos(rad), y: center + r * Math.sin(rad) };
        }

        const angles = [-90, -18, 54, 126, 198];
        let gridHTML = '';
        [1, 0.66, 0.33].forEach((scale) => {
            let pts = '';
            angles.forEach(a => { const p = getPoint(a, 100 * scale); pts += `${p.x},${p.y} `; });
            gridHTML += `<polygon points="${pts.trim()}" fill="none" stroke="#e6dfd5" stroke-width="1"/>`;
        });

        let axisHTML = '';
        angles.forEach(a => {
            const p = getPoint(a, 100);
            axisHTML += `<line x1="${center}" y1="${center}" x2="${p.x}" y2="${p.y}" stroke="#e6dfd5" stroke-width="1"/>`;
        });

        let dataPts = '';
        angles.forEach((a, i) => { const p = getPoint(a, dataValues[i]); dataPts += `${p.x},${p.y} `; });
        
        let dataPolyHTML = `<polygon points="${dataPts.trim()}" fill="var(--theme-color)" fill-opacity="0.15" stroke="var(--theme-color)" stroke-width="1.5"/>`;

        let labelsHTML = '', dotsHTML = '';
        angles.forEach((a, i) => {
            const lp = getPoint(a, 135), dp = getPoint(a, dataValues[i]);
            dotsHTML += `<circle cx="${dp.x}" cy="${dp.y}" r="3" fill="var(--theme-color)"/>`;
            let anchor = "middle";
            if (a === -18 || a === 54) anchor = "start";
            if (a === 126 || a === 198) anchor = "end";
            labelsHTML += `
                <text x="${lp.x}" y="${lp.y}" class="radar-label" text-anchor="${anchor}" alignment-baseline="middle">${labels[i]}</text>
                <text x="${lp.x}" y="${lp.y + 14}" class="radar-value-text" text-anchor="${anchor}">${dataValues[i]}</text>
            `;
        });

        container.innerHTML = `<svg class="radar-svg" viewBox="0 0 ${size} ${size}">${gridHTML}${axisHTML}${dataPolyHTML}${dotsHTML}${labelsHTML}</svg>`;
    }
</script>
</body>
</html>
